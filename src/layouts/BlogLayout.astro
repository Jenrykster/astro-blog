---
import Icon from "astro-icon";
import { Picture } from "astro-imagetools/components";
import Layout from "./Layout.astro";

const { slug } = Astro.params;
const { title, description, date, image } = Astro.props.frontmatter;
const {
  PUBLIC_VIEW_COUNTER_API: viewCounterURL,
  PUBLIC_SECRET_LOL: secret,
  DEV: devEnv,
} = import.meta.env;
---

<Layout title={title}>
  <h1 class="text-text font-body text-4xl font-bold text-center">{title}</h1>
  <div
    class="flex gap-4 flex-col items-center max-w-sm w-1/2 justify-around mb-4"
  >
    <div
      class="flex text-accent items-center gap-2 no-underline w-12 justify-between"
    >
      <Icon name="ic:outline-visibility" size={24} />
      <p id="number-of-views">...</p>
    </div>
    <div class="flex w-auto text-accent underline">
      <p class="text-text text-center font-body">
        Published on {new Date(date).toLocaleDateString("en-GB")}
      </p>
    </div>
  </div>
  <Picture src={image.url} alt={image.alt} width="550" height="300" />
  <q class="text-text font-body p-4">
    {description}
  </q>
  <section class="text-text font-body self-center blog-post max-w-3xl w-full">
    <slot />
  </section>
  <script define:vars={{ slug, secret, viewCounterURL, devEnv }}>
    async function getAndUpdateViews() {
      const res = await fetch(
        `${viewCounterURL}?post=${slug}&secret=${secret}`,
      );
      const info = await res.json();

      if (info.item) {
        document.querySelector("#number-of-views").innerText =
          info.item.numberOfViews;
      }
    }
    if (!devEnv) {
      window.addEventListener("astro:after-swap", getAndUpdateViews);
      getAndUpdateViews();
    }
  </script>
</Layout>
